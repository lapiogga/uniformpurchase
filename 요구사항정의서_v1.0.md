# 피복 구매관리 시스템 - 요구사항정의서

| 항목 | 내용 |
|------|------|
| **문서번호** | SRS-UNIFORM-2026-001 |
| **버전** | v1.0 |
| **작성일** | 2026-02-24 |
| **시스템명** | 피복 구매관리 시스템 |
| **목적** | 군 피복 포인트 기반 온/오프라인 구매관리 시스템의 요구사항을 구체적으로 정의 |

---

## 1. 시스템 개요

### 1.1 시스템 목적
군 장병(장교, 부사관, 군무원)에게 계급별로 피복포인트를 지급하고, 피복판매소를 통한 온라인/오프라인 구매, 재고관리, 체척권(맞춤피복) 관리를 통합 수행하는 웹 기반 구매관리 시스템이다.

### 1.2 시스템 범위
- **피복포인트 관리**: 계급별 연간 포인트 산정, 지급, 진급 추가 지급, 일할계산
- **온라인 구매**: 사용자 직접 품목 선택, 장바구니, 주문, 배송 추적
- **오프라인 판매**: 피복판매소에서 직접 판매, 반품 처리
- **재고관리**: 판매소별 품목/규격별 재고, 입고, 조정
- **체척권 관리**: 맞춤피복 체척권 발행, 등록, 취소, 정산
- **사용자/기초 데이터 관리**: 사용자, 판매소, 체척업체, 품목 분류/규격

### 1.3 대상 사용자
| 역할 | 영문 코드 | 설명 | 주요 업무 |
|------|-----------|------|-----------|
| 군수담당자 | `admin` | 시스템 전체 관리자 | 사용자/포인트/품목/판매소/체척업체/체척권/메뉴 관리 |
| 피복판매소 담당자 | `store` | 피복 판매 현장 운영자 | 오프라인 판매, 온라인 주문 배송, 재고/입고/반품, 통계 |
| 체척업체 담당자 | `tailor` | 맞춤피복 가공 업체 | 체척권 등록, 현황 조회 |
| 일반사용자 | `user` | 장교, 부사관, 군무원 | 온라인 구매, 구매내역/배송 확인, 포인트/체척권 조회 |

### 1.4 기술 스택
| 항목 | 기술 | 버전/비고 |
|------|------|-----------|
| 프론트엔드 프레임워크 | Next.js (App Router) | v16, React 19, TypeScript |
| 백엔드/DB | Supabase | PostgreSQL + Auth + RLS |
| UI 라이브러리 | shadcn/ui | Tailwind CSS v4, radix-ui |
| 폼 관리 | react-hook-form + zod | 유효성 검사 |
| 알림 | sonner | Toast 알림 |
| 데이터 변경 | Next.js Server Actions | `src/actions/` 디렉토리 |

---

## 2. 사용자 역할별 요구사항

### 2.1 군수담당자 (admin)

#### 2.1.1 사용자 관리
| 요구사항 ID | 요구사항 | 우선순위 | 상세 |
|------------|---------|---------|------|
| REQ-A-001 | 사용자 목록 조회 | 필수 | 역할/계급/이름 필터, 페이지당 20건, 이름·군번·계급·역할·소속·상태·등록일 표시 |
| REQ-A-002 | 사용자 개별 등록 | 필수 | 이름, 이메일, 역할, 계급, 군번, 소속, 입대일, 진급일, 퇴직예정일 입력. Supabase Auth 사용자 생성 + users 테이블 저장 + point_summary 초기 레코드 생성 |
| REQ-A-003 | 사용자 일괄 등록 | 선택 | CSV 파일 업로드, 파싱 → 유효성 검사 → 개별 등록 반복, 성공/실패 건수 표시 |
| REQ-A-004 | 사용자 정보 수정 | 필수 | 이름, 계급, 소속, 진급일, 퇴직예정일, 상태(활성/비활성) 수정. 계급 변경 시 진급일 필수 입력, 진급 포인트 추가 자동 트리거 |
| REQ-A-005 | 역할별 소속 지정 | 필수 | store 역할: 소속 판매소(store_id) 필수 지정, tailor 역할: 소속 업체(tailor_id) 필수 지정 |

#### 2.1.2 포인트 관리
| 요구사항 ID | 요구사항 | 우선순위 | 상세 |
|------------|---------|---------|------|
| REQ-A-010 | 포인트 산정 (미리보기) | 필수 | 해당 연도 전체 사용자의 피복포인트를 계급·호봉·퇴직예정일 기반으로 산정하여 미리보기 표시. DB 변경 없음 |
| REQ-A-011 | 포인트 일괄 지급 | 필수 | 산정 결과를 실제 지급 처리. point_ledger에 type='grant' 기록, point_summary.total_points 갱신 |
| REQ-A-012 | 중복 지급 방지 | 필수 | 해당 연도에 이미 지급된 경우 재지급 불가 |
| REQ-A-013 | 진급 포인트 추가 | 필수 | 진급 시 잔여기간(진급일~12/31) 차액을 일할계산하여 추가 지급 |
| REQ-A-014 | 포인트 현황 조회 | 필수 | 전체 사용자별 총지급/사용/예약/잔여 표시, 이름/계급 필터 |
| REQ-A-015 | 포인트 변동 이력 | 필수 | 사용자별 포인트 변동(지급/차감/추가/반환/예약/해제) 이력 시간순 조회 |

#### 2.1.3 품목 관리
| 요구사항 ID | 요구사항 | 우선순위 | 상세 |
|------------|---------|---------|------|
| REQ-A-020 | 품목 분류 3단계 관리 | 필수 | 대분류(level 1) → 중분류(level 2) → 소분류(level 3) 계층 구조. 트리 형태 좌측 패널 |
| REQ-A-021 | 분류 CRUD | 필수 | 분류명, 상위분류, 단계, 순서, 사용 여부. 하위 분류 존재 시 삭제 불가 |
| REQ-A-022 | 품목 CRUD | 필수 | 품목명, 소분류, 품목유형(완제품/맞춤피복), 단가, 이미지, 설명, 사용 여부 |
| REQ-A-023 | 완제품 규격 관리 | 필수 | 완제품만 규격(사이즈) 관리 가능. 규격명(95, 100, 105 등), 순서, 사용 여부. 재고 있는 규격 삭제 불가 |
| REQ-A-024 | 맞춤피복 규격 없음 | 필수 | 맞춤피복(custom)은 규격을 관리하지 않음. 주문수량 항상 1, 재고관리 안 함 |

#### 2.1.4 기초 데이터 관리
| 요구사항 ID | 요구사항 | 우선순위 | 상세 |
|------------|---------|---------|------|
| REQ-A-030 | 피복판매소 CRUD | 필수 | 판매소명, 주소, 연락처, 담당자, 사용 여부. 소속 사용자/재고 존재 시 삭제 불가(비활성만) |
| REQ-A-031 | 체척업체 CRUD | 필수 | 업체명, 사업자번호, 대표자, 주소, 연락처, 은행명/계좌번호/예금주, 사용 여부. 등록된 체척권 존재 시 삭제 불가 |
| REQ-A-032 | 메뉴 관리 | 필수 | 메뉴명, URL, 상위메뉴, 순서, 접근 역할(복수 선택), 사용 여부. Pull-Down 방식 |

#### 2.1.5 체척권 관리
| 요구사항 ID | 요구사항 | 우선순위 | 상세 |
|------------|---------|---------|------|
| REQ-A-040 | 체척권 현황 조회 | 필수 | 전체 체척권 목록, 상태/기간/사용자 필터. 체척권번호, 사용자, 품목, 금액, 상태, 발행일, 업체 표시 |
| REQ-A-041 | 체척권 취소 승인/거부 | 필수 | 취소 요청된(cancel_requested) 체척권에 대해 승인(→cancelled, 포인트 반환) 또는 거부(→issued, 원상복구) |
| REQ-A-042 | 체척업체 정산 | 필수 | 업체별/기간별 등록된(registered) 체척권 금액 집계, 정산 생성(pending), 정산 확정(confirmed) |

---

### 2.2 피복판매소 담당자 (store)

#### 2.2.1 오프라인 판매
| 요구사항 ID | 요구사항 | 우선순위 | 상세 |
|------------|---------|---------|------|
| REQ-S-001 | 오프라인 판매 등록 | 필수 | ① 사용자 검색(군번/이름) → ② 가용포인트 확인 → ③ 품목유형 탭(완제품/맞춤피복) → ④ 품목+규격+수량 선택 → ⑤ 가용포인트 범위 검증 → ⑥ 판매 확정 |
| REQ-S-002 | 완제품 오프라인 판매 처리 | 필수 | orders(offline, delivered) 생성, order_items 생성, inventory 재고 차감, inventory_log(sale) 기록, point_ledger(deduct), point_summary 갱신 |
| REQ-S-003 | 맞춤피복 오프라인 판매 처리 | 필수 | orders(offline, delivered) 생성, order_items 생성, tailoring_tickets(issued) 체척권 발행, point_ledger(deduct), point_summary 갱신. 수량 1 고정 |
| REQ-S-004 | 판매 내역 조회 | 필수 | 기간/사용자명/품목유형 필터, 주문번호·사용자·품목유형·금액·판매일 표시 |
| REQ-S-005 | 반품 처리 (완제품) | 필수 | 판매 내역에서 반품 주문 선택, 반품 항목/수량 선택. order_items(returned), inventory 재고 추가, inventory_log(return), point_ledger(add), point_summary 갱신 |
| REQ-S-006 | 반품 처리 (맞춤피복) | 필수 | 체척권 상태가 'issued'(미등록)인 경우만 반품 가능. tailoring_tickets(cancelled), point_ledger(add), point_summary 갱신. 등록된(registered) 체척권은 반품 불가 |

#### 2.2.2 온라인 주문 관리
| 요구사항 ID | 요구사항 | 우선순위 | 상세 |
|------------|---------|---------|------|
| REQ-S-010 | 온라인 주문 목록 | 필수 | 상태별 탭(전체/대기/확인/배송중/완료/취소), 주문번호·사용자·품목유형·금액·배송방법·상태·주문일 표시 |
| REQ-S-011 | 주문 상태 변경 | 필수 | pending→confirmed→shipping→delivered 순서 전이. 각 단계별 버튼 표시 |
| REQ-S-012 | 배송 완료 확정 처리 | 필수 | inventory 재고 차감, inventory_log(sale), point_ledger(deduct + release), point_summary(used_points 증가, reserved_points 감소) |
| REQ-S-013 | 직권 취소 | 필수 | 재고 부족 등 사유로 판매소가 직접 주문 취소. 배송 확정 전 주문만 가능. 취소 사유 기록, 예약포인트 해제 |

#### 2.2.3 재고관리
| 요구사항 ID | 요구사항 | 우선순위 | 상세 |
|------------|---------|---------|------|
| REQ-S-020 | 재고 현황 조회 | 필수 | 판매소 내 품목별/규격별 현재고, 분류 필터, 재고 부족(≤5) 하이라이트, 변동 이력 Dialog |
| REQ-S-021 | 입고 처리 | 필수 | 품목+규격+수량 입력, inventory 수량 증가, inventory_log(incoming) 기록 |
| REQ-S-022 | 재고 조정 | 필수 | 품목+규격 선택, 조정수량(+/-)+사유 입력, inventory 변경, inventory_log(adjust_up/adjust_down) 기록. 조정 후 수량 ≥ 0 |
| REQ-S-023 | 배송지 관리 | 필수 | 자기 판매소의 직접 배송 가능 지역 CRUD. 배송지명, 주소, 비고, 사용여부 |

#### 2.2.4 통계
| 요구사항 ID | 요구사항 | 우선순위 | 상세 |
|------------|---------|---------|------|
| REQ-S-030 | 일별 판매현황 | 필수 | 기간 선택, 날짜별 판매건수·판매금액 집계, 합계 행 |
| REQ-S-031 | 품목별 판매현황 | 필수 | 기간+분류 필터, 품목명·규격·판매수량·판매금액 집계 |
| REQ-S-032 | 사용자별 판매현황 | 필수 | 기간+사용자검색 필터, 사용자명·계급·구매건수·구매금액 집계 |

---

### 2.3 체척업체 담당자 (tailor)

| 요구사항 ID | 요구사항 | 우선순위 | 상세 |
|------------|---------|---------|------|
| REQ-T-001 | 체척권 등록 | 필수 | 체척권번호(TKT-XXXXXXXX-XXXXX) 입력 → 조회 → 상태 'issued'인 경우만 등록 버튼 활성 → 등록 시 status→'registered', tailor_id 지정, registered_at 기록 |
| REQ-T-002 | 등록 체척권 현황 | 필수 | 자사 등록 체척권 목록 조회, 기간/상태 필터 |
| REQ-T-003 | 대시보드 | 필수 | 등록 체척권 수, 당월 등록 건수, 최근 정산 금액 요약 |

---

### 2.4 일반사용자 (user)

#### 2.4.1 온라인 구매
| 요구사항 ID | 요구사항 | 우선순위 | 상세 |
|------------|---------|---------|------|
| REQ-U-001 | 쇼핑 메인 | 필수 | 상단 가용포인트 표시. 유형 Select(완제품/맞춤피복). 완제품: 판매소 먼저 선택 필수 → 해당 판매소에 재고 있는 품목만 표시. 맞춤피복: 판매소 선택 불필요, 전체 품목 표시 |
| REQ-U-002 | 품목 상세 | 필수 | 이미지, 품목명, 분류, 단가, 설명. 완제품: 선택된 판매소명 표시, 해당 판매소 재고 있는 규격만 표시(규격명+재고수량), 수량 1 고정. 맞춤피복: 체척권 발행 안내, 수량 1 고정 |
| REQ-U-003 | 장바구니 | 필수 | 완제품/맞춤피복 섹션 분리. 섹션별 전체선택 체크박스. 완제품: 수량 +/- 조정 가능, 판매소명 표시. 맞춤피복: 수량 1 고정. 섹션별 독립 구매 버튼 |
| REQ-U-004 | 구매 확인 (완제품) | 필수 | 판매소명 표시, 배송방법 선택(택배: 주소 입력 / 직접배송: 판매소 배송지 목록 선택), 가용포인트 확인 후 주문 확정 |
| REQ-U-005 | 구매 확인 (맞춤피복) | 필수 | 체척권 발행 안내 표시, 판매소/배송 정보 없음, 가용포인트 확인 후 주문 확정 |
| REQ-U-006 | 온라인 주문 처리 | 필수 | orders(online, pending) 생성, order_items 생성, 예약포인트 추가(point_ledger type='reserve', point_summary.reserved_points 증가). 맞춤피복: 체척권 자동 발행 |
| REQ-U-007 | 구매 취소 | 필수 | 배송 확정(delivered) 전까지만 취소 가능. orders.status→'cancelled', 예약포인트 해제(point_ledger type='release', point_summary.reserved_points 감소), 맞춤피복 체척권 취소(미등록 시) |

#### 2.4.2 조회
| 요구사항 ID | 요구사항 | 우선순위 | 상세 |
|------------|---------|---------|------|
| REQ-U-010 | 구매 내역 조회 | 필수 | 기간/주문유형/상태 필터, 주문번호·유형·품목유형·금액·상태·주문일 표시 |
| REQ-U-011 | 구매 상세 | 필수 | 주문정보, 품목목록(품목명·규격·수량·단가·소계), 배송정보, 맞춤피복 시 체척권 정보, 취소 버튼 |
| REQ-U-012 | 포인트 현황 | 필수 | 총지급/사용/예약/잔여 요약, 변동이력 테이블(일시·유형·금액·잔액·설명), 기간/유형 필터 |
| REQ-U-013 | 체척권 현황 | 필수 | 체척권번호·품목·금액·상태·발행일·업체 표시. 상태='issued'인 체척권에 취소 요청 버튼 |

---

## 3. 비즈니스 규칙

### 3.1 포인트 관리 규칙

| 규칙 ID | 규칙명 | 상세 설명 |
|---------|--------|-----------|
| BR-001 | 가용포인트 산출 | `가용포인트 = 총지급포인트(total_points) - 사용포인트(used_points) - 예약포인트(reserved_points)` |
| BR-002 | 포인트 범위 내 거래 | 오프라인 판매 및 온라인 구매 시 가용포인트 범위 내에서만 거래 가능 |
| BR-003 | 연간 1회 일괄 지급 | 매년 1월 1일에 전체 사용자에게 일괄 지급. 동일 연도 중복 지급 불가 |
| BR-004 | 계급별 차등 지급 | 장성급: 100만원, 대령~소령: 80만원, 대위~소위: 60만원, 준위: 50만원, 부사관: 40만원, 군무원: 40만원 |
| BR-005 | 호봉 추가 | 근무년수(현재연도 - 입대연도)에 따라 1호봉씩, 호봉당 5,000원 추가 |
| BR-006 | 진급 시 일할계산 | 진급일~12월31일 잔여일수에 대해 (신계급 일일금액 - 구계급 일일금액) × 잔여일수 추가 지급 |
| BR-007 | 퇴직예정자 일할계산 | 퇴직예정일이 있는 경우 `기본금액 × (1/1~퇴직예정일 일수) / 365`로 일할계산 |

### 3.2 품목/재고 규칙

| 규칙 ID | 규칙명 | 상세 설명 |
|---------|--------|-----------|
| BR-010 | 완제품/맞춤피복 분리 | 완제품과 맞춤피복은 별도로 판매/구매 (동시 구매 불가) |
| BR-011 | 맞춤피복 수량 1 고정 | 맞춤피복 주문수량은 항상 1개 |
| BR-012 | 맞춤피복 재고 없음 | 맞춤피복은 재고관리 대상이 아님 (체척업체에서 제작) |
| BR-013 | 재고 판매소별 관리 | 재고는 피복판매소별 + 규격별로 관리 |
| BR-014 | 완제품 재고 부족 판매 불가 | 오프라인 판매 시 재고 부족이면 판매 불가 |
| BR-015 | 온라인 판매소 선택 필수 | 온라인 완제품 구매 시 판매소를 먼저 선택해야 하며, 해당 판매소 재고 있는 품목만 표시 |
| BR-016 | 온라인 맞춤피복 판매소 불필요 | 온라인 맞춤피복 구매 시 판매소 선택 불필요 |

### 3.3 주문/배송 규칙

| 규칙 ID | 규칙명 | 상세 설명 |
|---------|--------|-----------|
| BR-020 | 배송 확정 전 취소 가능 | 온라인 주문은 배송 확정(delivered) 전까지만 취소 가능 |
| BR-021 | 반품은 판매소에서만 | 반품은 피복판매소에서만 처리 가능 |
| BR-022 | 배송 방법 2종 | 택배 배송(주소 입력) 또는 직접 배송(판매소 배송지 목록 선택) |
| BR-023 | 맞춤피복 배송 없음 | 맞춤피복 온라인 주문은 배송 정보 불필요 (체척권 발행으로 처리) |

### 3.4 체척권 규칙

| 규칙 ID | 규칙명 | 상세 설명 |
|---------|--------|-----------|
| BR-030 | 체척권 자동 발행 | 맞춤피복 판매/구매 시 체척권 자동 발행 (status='issued'), 포인트 차감 |
| BR-031 | 등록 후 취소 불가 | 체척업체에서 체척권을 등록(registered)하면 이후 취소 불가 |
| BR-032 | 취소 승인권 | 체척권 취소 승인은 군수담당자만 가능 |
| BR-033 | 등록된 체척권 반품 불가 | 체척권이 등록(registered)된 맞춤피복은 반품 불가 |

---

## 4. 데이터 요구사항

### 4.1 엔티티 목록

| # | 테이블명 | 한글명 | 설명 | 주요 관계 |
|---|---------|--------|------|-----------|
| 1 | `stores` | 피복판매소 | 판매소 기본 정보 | users(1:N), delivery_zones(1:N), inventory(1:N) |
| 2 | `tailors` | 체척업체 | 체척업체 기본 정보 | users(1:N), tailoring_tickets(1:N), tailor_settlements(1:N) |
| 3 | `users` | 사용자 | 4개 역할 통합 | stores(N:1), tailors(N:1), orders(1:N), point_summary(1:1) |
| 4 | `categories` | 품목 분류 | 대/중/소 3단계 자기참조 | products(1:N), categories(self-ref) |
| 5 | `products` | 품목 | 완제품/맞춤피복 | categories(N:1), product_specs(1:N), order_items(1:N) |
| 6 | `product_specs` | 규격 | 완제품 사이즈 | products(N:1), inventory(1:N) |
| 7 | `delivery_zones` | 직접 배송지 | 판매소별 배송 지역 | stores(N:1) |
| 8 | `inventory` | 재고 | 판매소+품목+규격별 | stores(N:1), products(N:1), product_specs(N:1) |
| 9 | `inventory_log` | 재고 변동 이력 | 입고/판매/반품/조정 | inventory(N:1) |
| 10 | `point_summary` | 포인트 요약 | 사용자별 잔액 | users(1:1) |
| 11 | `point_ledger` | 포인트 원장 | 모든 변동 이력 | users(N:1) |
| 12 | `orders` | 주문 | 온/오프라인 통합 | users(N:1), stores(N:1), order_items(1:N) |
| 13 | `order_items` | 주문 상세 | 주문 품목 목록 | orders(N:1), products(N:1) |
| 14 | `tailoring_tickets` | 체척권 | 맞춤피복 체척권 | order_items(N:1), users(N:1), tailors(N:1) |
| 15 | `tailor_settlements` | 체척업체 정산 | 업체별 정산 | tailors(N:1) |
| 16 | `menus` | 메뉴 | 역할별 메뉴 관리 | menus(self-ref) |

### 4.2 주요 테이블 스키마

#### users 테이블
| 컬럼 | 타입 | 제약 | 설명 |
|------|------|------|------|
| id | uuid | PK, FK → auth.users.id | Supabase Auth 연동 |
| email | varchar(255) | UNIQUE, NOT NULL | 이메일 (로그인 ID) |
| name | varchar(50) | NOT NULL | 이름 |
| role | varchar(20) | NOT NULL, CHECK(admin/store/tailor/user) | 역할 |
| rank | varchar(20) | CHECK(12종 계급) | 계급 (일반사용자만) |
| military_number | varchar(30) | | 군번/사번 |
| unit | varchar(100) | | 소속 |
| enlist_date | date | | 입대일/근무시작일 |
| promotion_date | date | | 최근 진급일 |
| retirement_date | date | | 퇴직예정일 |
| store_id | uuid | FK → stores.id | 소속 판매소 (store 역할) |
| tailor_id | uuid | FK → tailors.id | 소속 업체 (tailor 역할) |
| is_active | boolean | default true | 활성 상태 |

#### orders 테이블
| 컬럼 | 타입 | 제약 | 설명 |
|------|------|------|------|
| id | uuid | PK | |
| order_number | varchar(30) | UNIQUE, NOT NULL | 자동생성 (ORD-YYYYMMDD-NNNNN) |
| user_id | uuid | FK → users.id, NOT NULL | 구매자 |
| store_id | uuid | FK → stores.id, NOT NULL | 판매소 |
| order_type | varchar(20) | NOT NULL, CHECK(online/offline) | 주문유형 |
| product_type | varchar(20) | NOT NULL, CHECK(finished/custom) | 품목유형 |
| status | varchar(20) | NOT NULL, default 'pending' | 주문상태 (6종) |
| total_amount | integer | NOT NULL | 총 금액 (원) |
| delivery_method | varchar(20) | CHECK(parcel/direct) | 배송방법 (온라인만) |
| delivery_zone_id | uuid | FK → delivery_zones.id | 직접배송지 |
| delivery_address | text | | 택배 배송주소 |
| cancel_reason | text | | 취소 사유 |

#### point_ledger 테이블 (원장)
| 컬럼 | 타입 | 제약 | 설명 |
|------|------|------|------|
| id | uuid | PK | |
| user_id | uuid | FK → users.id, NOT NULL | 사용자 |
| point_type | varchar(20) | NOT NULL | grant/deduct/add/return/reserve/release |
| amount | integer | NOT NULL | 금액 (양수) |
| balance_after | integer | | 변동 후 잔액 |
| description | text | | 설명 |
| reference_type | varchar(30) | | 참조 유형 (order/ticket/annual) |
| reference_id | uuid | | 참조 ID |
| fiscal_year | smallint | | 회계연도 |

### 4.3 계급 코드 체계
| 코드 | 한글명 | 연간 포인트 |
|------|--------|------------|
| general | 장성급 | 1,000,000원 |
| colonel | 대령 | 800,000원 |
| lt_colonel | 중령 | 800,000원 |
| major | 소령 | 800,000원 |
| captain | 대위 | 600,000원 |
| first_lt | 중위 | 600,000원 |
| second_lt | 소위 | 600,000원 |
| warrant | 준위 | 500,000원 |
| sgt_major | 상사 | 400,000원 |
| master_sgt | 중사 | 400,000원 |
| sgt | 하사 | 400,000원 |
| civil_servant | 군무원 | 400,000원 |

---

## 5. 상태 전이 요구사항

### 5.1 주문(Order) 상태 전이

```
[온라인 주문]
  pending ──→ confirmed ──→ shipping ──→ delivered
  pending ──→ cancelled (사용자 취소)
  confirmed ──→ cancelled (직권 취소)

[오프라인 판매]
  delivered (즉시 완료)
  delivered ──→ returned (반품)
```

| 현재 상태 | 변경 가능 상태 | 트리거 | 처리자 |
|----------|--------------|--------|--------|
| pending | confirmed | 주문 확인 | 판매소 |
| pending | cancelled | 구매 취소 | 사용자 |
| confirmed | shipping | 배송 시작 | 판매소 |
| confirmed | cancelled | 직권 취소 | 판매소 |
| shipping | delivered | 배송 완료 | 판매소 |
| delivered | returned | 반품 처리 | 판매소 (오프라인만) |

### 5.2 체척권(Tailoring Ticket) 상태 전이

```
  issued ──→ registered (업체 등록, 이후 취소 불가)
  issued ──→ cancel_requested ──→ cancelled (취소 승인)
  issued ──→ cancel_requested ──→ issued (취소 거부, 원상복구)
```

| 현재 상태 | 변경 가능 상태 | 트리거 | 처리자 |
|----------|--------------|--------|--------|
| issued | registered | 체척권 등록 | 체척업체 |
| issued | cancel_requested | 취소 요청 | 사용자, 판매소 |
| cancel_requested | cancelled | 취소 승인 | 군수담당자 |
| cancel_requested | issued | 취소 거부 | 군수담당자 |

---

## 6. 화면(UI) 요구사항

### 6.1 전체 화면 목록 (39개)

| 구분 | 화면 ID | 화면명 | URL | 역할 |
|------|---------|--------|-----|------|
| 공통 | S-01 | 로그인 | `/` | 공개 |
| 공통 | S-02 | 비밀번호 찾기 | `/forgot-password` | 공개 |
| 공통 | S-03 | 비밀번호 변경 | `/change-password` | 인증 |
| 관리자 | A-01 | 대시보드 | `/admin/dashboard` | admin |
| 관리자 | A-02 | 사용자 목록 | `/admin/users` | admin |
| 관리자 | A-03 | 사용자 등록 | `/admin/users/new` | admin |
| 관리자 | A-04 | 포인트 산정 | `/admin/points` | admin |
| 관리자 | A-05 | 포인트 현황 | `/admin/points/status` | admin |
| 관리자 | A-06 | 품목 관리 | `/admin/products` | admin |
| 관리자 | A-07 | 판매소 관리 | `/admin/stores` | admin |
| 관리자 | A-08 | 체척업체 관리 | `/admin/tailors` | admin |
| 관리자 | A-09 | 체척권 관리 | `/admin/tickets` | admin |
| 관리자 | A-10 | 정산 관리 | `/admin/settlements` | admin |
| 관리자 | A-11 | 메뉴 관리 | `/admin/menus` | admin |
| 관리자 | A-12 | 사용자 수정 | `/admin/users/[id]` | admin |
| 판매소 | ST-01 | 대시보드 | `/store/dashboard` | store |
| 판매소 | ST-02 | 오프라인 판매 | `/store/sales/new` | store |
| 판매소 | ST-03 | 판매 내역 | `/store/sales` | store |
| 판매소 | ST-04 | 반품 처리 | `/store/sales/return` | store |
| 판매소 | ST-05 | 온라인 주문 관리 | `/store/orders` | store |
| 판매소 | ST-06 | 온라인 주문 상세 | `/store/orders/[id]` | store |
| 판매소 | ST-07 | 재고 현황 | `/store/inventory` | store |
| 판매소 | ST-08 | 입고 처리 | `/store/inventory/incoming` | store |
| 판매소 | ST-09 | 재고 조정 | `/store/inventory/adjust` | store |
| 판매소 | ST-10 | 배송지 관리 | `/store/delivery` | store |
| 판매소 | ST-11 | 일별 판매현황 | `/store/stats/daily` | store |
| 판매소 | ST-12 | 품목별 판매현황 | `/store/stats/products` | store |
| 판매소 | ST-13 | 사용자별 판매현황 | `/store/stats/users` | store |
| 체척업체 | T-01 | 대시보드 | `/tailor/dashboard` | tailor |
| 체척업체 | T-02 | 체척권 등록 | `/tailor/tickets/register` | tailor |
| 체척업체 | T-03 | 체척권 현황 | `/tailor/tickets` | tailor |
| 사용자 | U-01 | 쇼핑 메인 | `/my/shop` | user |
| 사용자 | U-02 | 품목 상세 | `/my/shop/[id]` | user |
| 사용자 | U-03 | 장바구니 | `/my/cart` | user |
| 사용자 | U-04 | 구매 확인 | `/my/checkout` | user |
| 사용자 | U-05 | 구매 내역 | `/my/orders` | user |
| 사용자 | U-06 | 구매 상세 | `/my/orders/[id]` | user |
| 사용자 | U-07 | 포인트 현황 | `/my/points` | user |
| 사용자 | U-08 | 체척권 현황 | `/my/tickets` | user |

### 6.2 디자인 가이드
| 항목 | 규격 |
|------|------|
| 테마 유형 | 정부/공공기관형 (밝고 정형화된 사무적 톤) |
| 색상 체계 | 흰색 배경, 감청색 Primary (#1D4ED8 계열), zinc 무채색 보조 |
| 헤더/사이드바 배경 | 옅은 베이지 (`#FAF7F2`) |
| 폰트 | Arial + Noto Sans KR (variable), 15px, 줄간격 1.4 |
| 버튼 모서리 | `rounded-[4px]`, 액션 버튼에 배경색 필수 |
| 배지 모서리 | `rounded-[2px]`, 무채색 zinc 계열 |
| 금액 표시 | 우측 정렬 + `font-variant-numeric: tabular-nums` |
| 레이아웃 | 고정 헤더(sticky top), Pull-Down 메뉴, 역할별 메뉴 표시 |

---

## 7. 인증/권한 요구사항

### 7.1 인증
| 요구사항 ID | 요구사항 | 상세 |
|------------|---------|------|
| REQ-AUTH-001 | 이메일/비밀번호 로그인 | Supabase Auth `signInWithPassword` |
| REQ-AUTH-002 | 역할별 리다이렉트 | admin→`/admin/dashboard`, store→`/store/dashboard`, tailor→`/tailor/dashboard`, user→`/my/shop` |
| REQ-AUTH-003 | 비밀번호 찾기 | 등록된 이메일로 재설정 링크 발송 |
| REQ-AUTH-004 | 비밀번호 변경 | 최소 8자, 확인 필드 일치 검증 |
| REQ-AUTH-005 | 로그아웃 | 세션 종료 → 로그인 페이지 이동 |

### 7.2 권한 제어 (이중 보호)

#### Next.js 미들웨어 (1차)
| 경로 패턴 | 접근 허용 역할 | 비인증 시 |
|----------|--------------|----------|
| `/`, `/forgot-password` | 모든 사용자 | 허용 |
| `/admin/**` | admin | `/` 리다이렉트 |
| `/store/**` | store | `/` 리다이렉트 |
| `/tailor/**` | tailor | `/` 리다이렉트 |
| `/my/**` | user | `/` 리다이렉트 |
| 역할 불일치 | - | 해당 역할의 대시보드로 리다이렉트 |

#### Supabase RLS (2차)
| 테이블 | admin | store | tailor | user |
|--------|-------|-------|--------|------|
| users | ALL | SELECT(user만) | - | SELECT(본인) |
| stores | ALL | SELECT | SELECT | SELECT |
| tailors | ALL | SELECT | SELECT | SELECT |
| categories | ALL | SELECT | SELECT | SELECT |
| products | ALL | SELECT | SELECT | SELECT |
| product_specs | ALL | SELECT | SELECT | SELECT |
| delivery_zones | ALL | ALL(자기판매소) | - | SELECT |
| inventory | SELECT | ALL(자기판매소) | - | SELECT |
| inventory_log | SELECT | ALL(자기판매소) | - | - |
| point_summary | ALL | SELECT | - | SELECT(본인) |
| point_ledger | ALL | - | - | SELECT(본인) |
| orders | ALL | ALL(자기판매소) | - | SELECT(본인), INSERT(본인) |
| order_items | ALL | ALL(자기판매소) | - | SELECT(본인) |
| tailoring_tickets | ALL | SELECT | ALL(자사+미등록) | SELECT(본인) |
| tailor_settlements | ALL | - | SELECT(자사) | - |
| menus | ALL | SELECT | SELECT | SELECT |

---

## 8. API (Server Actions) 요구사항

### 8.1 API 목록 (61개)

| 모듈 | 파일 | API 수 | 주요 API |
|------|------|--------|----------|
| 인증 | actions/auth.ts | 5 | login, logout, resetPassword, updatePassword, getCurrentUser |
| 사용자 | actions/users.ts | 6 | getUsers, getUserById, createUser, bulkCreateUsers, updateUser, getCurrentUser |
| 품목 | actions/products.ts | 11 | categories CRUD(4), products CRUD(5), specs CRUD(3) |
| 포인트 | actions/points.ts | 6 | calculateAnnualPoints, grantAnnualPoints, triggerPromotionPoints, getPointSummary, getPointLedger, getAvailablePoints |
| 주문/판매 | actions/orders.ts | 8+3 | createOfflineSale, createOnlineOrder, cancelOrder, processReturn, updateOrderStatus, getOrders, getOrderById, 통계(3) |
| 재고 | actions/inventory.ts | 5 | getInventory, processIncoming, adjustInventory, getInventoryLog, getStoreInventoryForProduct |
| 체척권 | actions/tickets.ts | 5 | getTickets, registerTicket, requestCancelTicket, approveCancelTicket, getTicketByNumber |
| 정산 | actions/settlements.ts | 4 | getSettlements, calculateSettlement, createSettlement, confirmSettlement |
| 기초데이터 | 각 파일 | 12 | stores(4), tailors(4), delivery_zones(4), menus(4) |

### 8.2 공통 반환 형식
```typescript
{ success: boolean; data?: T; error?: string }
```

### 8.3 공통 에러 코드
| 에러 코드 | 설명 |
|----------|------|
| AUTH_INVALID | 인증 실패 |
| NOT_FOUND | 데이터 없음 |
| VALIDATION | 유효성 검사 실패 |
| DUPLICATE_EMAIL | 이메일 중복 |
| INSUFFICIENT_POINTS | 포인트 부족 |
| INSUFFICIENT_STOCK | 재고 부족 |
| INVALID_STATUS | 잘못된 상태 전이 |
| INVALID_STATUS_TRANSITION | 상태 전이 규칙 위반 |
| ALREADY_GRANTED | 이미 지급됨 |
| TICKET_REGISTERED | 이미 등록된 체척권 |
| HAS_CHILDREN | 하위 데이터 존재 |
| HAS_INVENTORY | 관련 재고 존재 |
| NEGATIVE_RESULT | 조정 후 음수 |
| INVALID_PRODUCT_TYPE | 잘못된 품목 유형 |

---

## 9. 비기능 요구사항

### 9.1 보안
| 요구사항 ID | 요구사항 | 상세 |
|------------|---------|------|
| NFR-SEC-001 | SQL 인젝션 방지 | Supabase 클라이언트 파라미터 바인딩 사용, 직접 SQL 금지 |
| NFR-SEC-002 | XSS 방지 | React 기본 이스케이프, `dangerouslySetInnerHTML` 사용 금지 |
| NFR-SEC-003 | 인증 검증 | 모든 Server Action에서 `supabase.auth.getUser()` 인증 확인 필수 |
| NFR-SEC-004 | 이중 권한 제어 | Next.js 미들웨어(라우트) + Supabase RLS(DB) 이중 보호 |
| NFR-SEC-005 | 환경변수 보호 | `.env.local`에 키 보관, Git 커밋 금지 |
| NFR-SEC-006 | 서비스 롤 키 제한 | admin.ts(서비스 롤)는 Server Action 전용, 사용자 생성 등 RLS 우회 필요 시만 사용 |

### 9.2 성능
| 요구사항 ID | 요구사항 | 상세 |
|------------|---------|------|
| NFR-PERF-001 | 서버 컴포넌트 기본 | 페이지는 Server Component 기본, 상태/이벤트 필요 시만 Client Component |
| NFR-PERF-002 | 페이지네이션 | 목록 조회 시 서버사이드 페이지네이션 (페이지당 20건) |
| NFR-PERF-003 | RLS 함수 캐싱 | `get_user_role()` 등 헬퍼 함수에 SECURITY DEFINER + STABLE 설정 |
| NFR-PERF-004 | 인덱스 | 주요 FK, 검색/필터 컬럼에 인덱스 적용 (23개) |

### 9.3 데이터 무결성
| 요구사항 ID | 요구사항 | 상세 |
|------------|---------|------|
| NFR-INT-001 | 포인트 정합성 | point_summary = SUM(point_ledger)로 검증 가능 |
| NFR-INT-002 | 재고 정합성 | inventory.quantity = 초기 + SUM(inventory_log)로 검증 가능 |
| NFR-INT-003 | 재고 음수 방지 | inventory.quantity CHECK(>= 0) 제약조건 |
| NFR-INT-004 | 중복 지급 방지 | point_ledger.fiscal_year로 연도별 중복 확인 |
| NFR-INT-005 | 자동 갱신 | updated_at 컬럼 자동 갱신 트리거 (8개 테이블) |
| NFR-INT-006 | 자동 번호 생성 | 주문번호(ORD-YYYYMMDD-NNNNN), 체척권번호(TKT-YYYYMMDD-NNNNN) PostgreSQL SEQUENCE 기반 자동 생성 |

### 9.4 동시성/트랜잭션
| 요구사항 ID | 요구사항 | 상세 |
|------------|---------|------|
| NFR-CON-001 | 트랜잭션 처리 | 오프라인 판매, 배송 확정, 반품 처리 등 다중 테이블 갱신 시 트랜잭션 필요 |
| NFR-CON-002 | 재고 동시성 | 온라인 구매 + 오프라인 판매 동시 발생 시 재고 충돌 방지 (FOR UPDATE 잠금 또는 RPC 내 직렬화) |

---

## 10. 테스트 요구사항

### 10.1 테스트 범위
| 유형 | 대상 | 기준 |
|------|------|------|
| 기능 테스트 | M1~M7 전 모듈 (50개 항목) | 모든 Server Action 및 UI 페이지 |
| 소스 품질 | TypeScript 컴파일, 빌드, 보안 (10개 항목) | 에러 0건, 취약점 0건 |
| 회귀 테스트 | 식별된 버그 6건 | 재발 방지 확인 |
| 반복 테스트 | 10회 Iteration | 빌드 + 정적 분석 + 라우트 검증 |

### 10.2 테스트 데이터 요건
| 테이블 | 최소 건수 | 비고 |
|--------|----------|------|
| users | 30+ | admin 2, store 3, tailor 3, user 22+ |
| stores | 3 | |
| tailors | 3 | |
| categories | 15+ | 3단계 구조 |
| products | 20+ | 완제품/맞춤 혼합 |
| product_specs | 40+ | 품목당 2~3개 |
| orders | 30+ | 온/오프, 다양한 상태 |
| inventory | 30+ | 판매소별, 규격별 |
| tailoring_tickets | 15+ | 발행/등록/취소 |
| **전체 합계** | **200건 이상** | |

---

## 11. 프로젝트 구조

### 11.1 디렉토리 구조
```
src/
├── app/
│   ├── layout.tsx, page.tsx          # 루트 레이아웃, 로그인 페이지
│   ├── (auth)/                       # forgot-password, change-password
│   ├── (admin)/layout.tsx            # 군수담당자 레이아웃
│   │   └── admin/                    # 12개 페이지
│   ├── (store)/layout.tsx            # 판매소 레이아웃
│   │   └── store/                    # 13개 페이지
│   ├── (tailor)/layout.tsx           # 체척업체 레이아웃
│   │   └── tailor/                   # 3개 페이지
│   └── (user)/layout.tsx             # 일반사용자 레이아웃
│       └── my/                       # 8개 페이지
├── actions/                          # Server Actions (도메인별)
│   ├── auth.ts                       # 인증
│   ├── users.ts                      # 사용자 관리
│   ├── products.ts                   # 품목/분류/규격
│   ├── points.ts                     # 포인트 관리
│   ├── orders.ts                     # 주문/판매/통계
│   ├── inventory.ts                  # 재고 관리
│   ├── tickets.ts                    # 체척권 관리
│   └── settlements.ts               # 정산 관리
├── components/
│   ├── ui/                           # shadcn/ui (수정 금지)
│   ├── layout/                       # 헤더, 메뉴
│   ├── forms/                        # 공통 폼
│   ├── tables/                       # 공통 테이블
│   └── shared/                       # 기타 공통
├── lib/
│   ├── supabase/                     # server.ts, client.ts, admin.ts, middleware.ts
│   ├── utils.ts
│   ├── constants.ts                  # 계급, 포인트 기준
│   └── menu-config.ts               # 역할별 메뉴
├── types/
│   ├── index.ts                      # 비즈니스 타입
│   └── database.ts                   # DB 테이블 타입
└── middleware.ts                      # Next.js 미들웨어 → lib/supabase/middleware.ts
```

### 11.2 Supabase 클라이언트 3종
| 파일 | 용도 | 사용 위치 |
|------|------|-----------|
| `lib/supabase/server.ts` | 쿠키 기반 세션 | Server Component, Server Action |
| `lib/supabase/client.ts` | 브라우저 세션 | Client Component |
| `lib/supabase/admin.ts` | 서비스 롤 키 (RLS 우회) | Server Action 전용 (사용자 생성 등) |

---

## 12. 식별된 이슈 및 제약사항

| # | 유형 | 내용 | 심각도 | 조치 방안 |
|---|------|------|--------|-----------|
| I-1 | 트랜잭션 | 오프라인 판매/배송확정 시 다중 테이블 갱신 | 높음 | PostgreSQL RPC 함수 또는 순차 처리 + 보상 로직 |
| I-2 | 동시성 | 온/오프라인 동시 판매 시 재고 충돌 | 높음 | FOR UPDATE 잠금 또는 RPC 내 직렬화 |
| I-3 | 보안 | RLS get_user_role() 함수 성능 | 중간 | SECURITY DEFINER + STABLE 캐싱 |
| I-4 | 확장성 | 주문/체척권 번호 시퀀스 영속성 | 낮음 | PostgreSQL SEQUENCE 사용 |
| I-5 | UI 복잡도 | 품목 관리(A-06) 트리+테이블 복합 레이아웃 | 중간 | 고정 너비 레이아웃 |

---

## 13. 요구사항 추적 매트릭스 (RTM)

| 요건정의 항목 | 기능모듈 | 화면 | API | DB 테이블 | 테스트 |
|-------------|---------|------|-----|----------|--------|
| 요건1 (사용자 종류) | M1, M2, M3 | A-02~A-03, A-07~A-08, A-12 | auth, users, stores, tailors | users, stores, tailors | F-01~F-15 |
| 요건2 (메뉴/로그인) | M1 | S-01~S-03, A-11 | auth, menus | menus | F-01~F-05 |
| 요건3 (피복 품목) | M4 | A-06 | products | categories, products, product_specs | F-16~F-21 |
| 요건4 (포인트 지급) | M5 | A-04~A-05, U-07 | points | point_summary, point_ledger | F-22~F-27 |
| 요건5 (오프라인 판매) | M6 | ST-02~ST-04 | orders | orders, order_items, inventory | F-28~F-29, F-36~F-37 |
| 요건6 (온라인 구매) | M6 | U-01~U-06, ST-05~ST-06 | orders, inventory | orders, order_items | F-30~F-35 |
| 요건7 (재고/포인트) | M5, M6 | ST-07~ST-09, ST-11~ST-13 | inventory, orders | inventory, inventory_log | F-38~F-42 |
| 요건8 (체척권 관리) | M7 | A-09~A-10, T-02~T-03, U-08 | tickets, settlements | tailoring_tickets, tailor_settlements | F-43~F-50 |

---

## 14. 용어 정의

| 용어 | 설명 |
|------|------|
| 피복 | 군인의 의류 및 장구류를 통칭 |
| 피복포인트 | 계급별로 매년 지급되는 피복 구매 가상 화폐 (단위: 원) |
| 가용포인트 | 실제 사용 가능한 포인트 = 총지급 - 사용 - 예약 |
| 예약포인트 | 온라인 구매 시 배송 확정 전까지 임시 차감되는 포인트 |
| 호봉 | 근무년수에 따른 추가 지급 단위 (1년=1호봉, 호봉당 5,000원) |
| 일할계산 | 일수 비례 계산 (진급/퇴직 시 적용) |
| 완제품 | 기성품 피복, 규격(사이즈)별 재고 관리 대상 |
| 맞춤피복 | 체척(신체 치수 측정) 후 제작하는 피복, 체척권 발행 대상 |
| 체척권 | 맞춤피복 주문 시 발행되는 제작 의뢰서, 체척업체에서 등록 후 제작 |
| 체척업체 | 맞춤피복을 제작하는 외부 업체 |
| 피복판매소 | 군 내 피복을 판매하는 매장 (온/오프라인 겸용) |
| 직접배송 | 피복판매소에서 지정된 배송지로 직접 배달 |
| 직권취소 | 판매소 담당자가 재고 부족 등의 사유로 주문을 강제 취소 |
| 정산 | 체척업체에 등록된 체척권 금액을 정리하여 지급 확정하는 절차 |
| 원장(Ledger) | 모든 거래 이력을 시간순으로 기록하는 장부 패턴 |
| RLS | Row Level Security, 행 수준 보안 정책 (Supabase/PostgreSQL) |

---

> **문서 끝** | 총 요구사항: 기능 65건 + 비기능 13건 = 78건 | 화면 39개 | API 61개 | DB 테이블 16개
